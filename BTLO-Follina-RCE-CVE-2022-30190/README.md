# BTLO Follina

## Overview
In this lab I analysed a malicious Word document using the Follina (CVE-2022-30190) exploit. I extracted the files and found the URL inside document.xml.rels. This word document will launch mtdt.exe to gain acess of the computer and run malicious code through PowerShell. I did my investigation to answer correct MITRE technique and CVE.

## Tools Used
- Notepad ++
- Virus Total
- 7 Zip

## Question 1) What is the SHA1 hash value of the sample? 
In this lab, I investigated a malicious Word document. My first task was to obtain the file's SHA1 hash value. I used PowerShell to gather the SHA1 hash value of the sample.

I used the PowerShell command to get the hash value 

```Get-fileHash "C:\Users\iman\Desktop\43eecf22e8f914d44df3da16c23dcc2e076a8753\sample\sample.doc" -Alogrithm SHA1 >```

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/06a69c40-a026-4bff-b312-a19e823d496a" />

## Question 2) According to VirusTotal, what is the full filetype of the provided sample?
I used VirusTotal to identify the full file type of the malicious document. The filetype is "Office Open XML Document."

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/eea2f2aa-292c-42db-a2c0-6f9332886644" />

## Question 3) Extract the URL that is used within the sample and submit it
I used Notepad++ to identify the malicious URL.

### URL
- https://www.xmlformats.com/office/word/2022/wordprocessingDrawing/RDF842l.html

### Why is this  Malicious?
The above URL is malicious because it is used to load an external website; normal Word documents typically do not load external websites. Even the domain of this URL is fake, and the attacker tried to make it look like it belongs to Microsoft.

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/1549a36d-005e-4ea2-b813-a3f5916c470f" />

## Question 4) What is the name of the XML file that is storing the extracted URL?
To find the name of the XML file, I had to rename sample.doc into to sample.zip file and extracted it.

Pathway - Word/_rels/######.XML file

## Question 5) The extracted URL accesses a HTML file that triggers the vulnerability to execute a malicious payload. According to the HTML processing functions, any files with fewer than <Number> bytes would not invoke the payload. Submit the <Number> 

At first, I was trying to access the URL file, but it's no longer working. I used ChatGPT to understand what happened behind the scenes. I extracted the remote HTML file used by the malicious doc. The exploit only works if the HTML file is at least a certain size. If the size is smaller than this number of bytes, the payload will not execute.

## Question 6) After execution, the sample will try to kill a process if it is already running. What is the name of this process? (Format: filename.ext) 

The malware uses msdt.exe to run it's malicious code, after it's running the malware check if the msdt.exe is still running, if it's running the malware kills it

### Why?
Because the attacker doesn't want msdt.exe to stay open, it might look suspicious to the user or defender, so the malware tries to kill it.

## Question 7) You were asked to write a process-based detection rule using Windows Event ID 4688. What would be the ProcessName and ParentProcessname used in this detection rule? 

Windows process ID 4688 - A new process was created
ParentProcessName is the Microsoft Word that opens, and the processName is mstd.exe. This is an abnormal behaviour because the doc file shouldn't be opening the mstd.exe.

## Question 8) Submit the MITRE technique ID used by the sample for Execution 
T1559 is used when malware abuses one Windows process to trigger another process
In Folina
- WINWORD.EXE loads the malicious HTML
- The HTML forces Word to call mstd.exe
- msdt.exe then runs the malicious command

## Question 9) Submit the CVE associated with the vulnerability that is being exploited
Found the answer using Virus Total.

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/95fc6668-34c2-4360-8abd-d9bce48c5b23" />
